<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <title>D3 16</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link href="css/nv.d3.css" rel="stylesheet">

  <script type="text/javascript" src="js/jquery-1.11.0.min.js"></script>
  <script type="text/javascript" src="js/d3.js"></script>
  <script type="text/javascript" src="js/nv.d3.js"></script>
  <script type="text/javascript" src="js/nvx.d3.js"></script>
</head>
<body>

<style>
  #chart1 svg {
    height: 100%;
    width: 100%;
  }
</style>

<table>
  <tr>
    <td style="font-weight: bold">Quantity:</td>
    <td style="font-weight: bold">Price:</td>
    <td style="font-weight: bold">Cost:</td>
  </tr>
  <tr>
    <td>
      <select id="quantityPlotMode" name="quantityPlotMode">
        <option value="smoothLine">Smooth Line</option>
        <option value="points">Points</option>
        <option value="bars">Bars</option>
      </select>
    </td>
    <td>
      <select id="pricePlotMode" name="pricePlotMode">
        <option value="smoothLine">Smooth Line</option>
        <option value="points">Points</option>
        <option value="bars">Bars</option>
      </select>
    </td>
    <td>
      <select id="costPlotMode" name="costPlotMode">
        <option value="smoothLine">Smooth Line</option>
        <option value="points">Points</option>
        <option value="bars">Bars</option>
      </select>
    </td>
  </tr>
  <tr>
    <td>
      <input type="checkbox" id="quantityHighlight">Highlight
    </td>
    <td>
      <input type="checkbox" id="priceHighlight">Highlight
    </td>
    <td>
      <input type="checkbox" id="costHighlight">Highlight
    </td>
  </tr>
  <tr>
    <td>
      <input type="checkbox" id="quantityIncludeZero">Include Zero
    </td>
    <td>
      <input type="checkbox" id="priceIncludeZero">Include Zero
    </td>
    <td>
      <input type="checkbox" id="costIncludeZero">Include Zero
    </td>
    <td>
      <input type="checkbox" id="useSameAxis">Use Same Axis
    </td>
  </tr>
</table>

<div id="chart1">
  <svg></svg>
</div>

<script type="text/javascript">
$(document).ready(function () {

  var quantityPlotMode = "smoothLine";
  var pricePlotMode = "smoothLine";
  var costPlotMode = "smoothLine";
  var quantityHighlight = false;
  var priceHighlight = false;
  var costHighlight = false;
  var quantityIncludeZero = false;
  var priceIncludeZero = false;
  var costIncludeZero = false;
  var useSameAxis = false;
  var dataList = [];

  $("#pricePlotMode").on("change", function (e) {
    pricePlotMode = $('#pricePlotMode').val();

    if (dataList.length > 0) {
      redraw();
    }
  });

  $("#quantityPlotMode").on("change", function (e) {
    quantityPlotMode = $('#quantityPlotMode').val();

    if (dataList.length > 0) {
      redraw();
    }
  });

  $("#costPlotMode").on("change", function (e) {
    costPlotMode = $('#costPlotMode').val();

    if (dataList.length > 0) {
      redraw();
    }
  });

  $("#quantityHighlight").on("change", function (e) {
    quantityHighlight = $('#quantityHighlight').is(':checked');

    if (dataList.length > 0) {
      redraw();
    }
  });

  $("#priceHighlight").on("change", function (e) {
    priceHighlight = $('#priceHighlight').is(':checked');

    if (dataList.length > 0) {
      redraw();
    }
  });

  $("#costHighlight").on("change", function (e) {
    costHighlight = $('#costHighlight').is(':checked');

    if (dataList.length > 0) {
      redraw();
    }
  });

  $("#quantityIncludeZero").on("change", function (e) {
    quantityIncludeZero = $('#quantityIncludeZero').is(':checked');

    if (dataList.length > 0) {
      redraw();
    }
  });

  $("#priceIncludeZero").on("change", function (e) {
    priceIncludeZero = $('#priceIncludeZero').is(':checked');

    if (dataList.length > 0) {
      redraw();
    }
  });

  $("#costIncludeZero").on("change", function (e) {
    costIncludeZero = $('#costIncludeZero').is(':checked');

    if (dataList.length > 0) {
      redraw();
    }
  });

  $("#useSameAxis").on("change", function (e) {
    useSameAxis = $('#useSameAxis').is(':checked');

    if (dataList.length > 0) {
      redraw();
    }
  });

  d3.json("data.json", function (error, data) {
    dataList = data;
    redraw();
  });

  function updateSize() {
    var width = $(window).width();
    var height = $(window).height();

    $('#chart1').width(width - 20);
    $('#chart1').height(height - 130);
  }

  $(window).resize(function () {
    updateSize();
  });
  updateSize();

  function redraw() {
    var minValue1 = Number.MAX_VALUE;
    var maxValue1 = Number.MIN_VALUE;
    var minValue2 = Number.MAX_VALUE;
    var maxValue2 = Number.MIN_VALUE;
    var minValue3 = Number.MAX_VALUE;
    var maxValue3 = Number.MIN_VALUE;

    if (useSameAxis) {
      dataList[2]['axis'] = 2;
    }
    else {
      dataList[2]['axis'] = 3;
    }
    dataList.forEach(function (data) {
      var axis = data.axis;
      data.values.forEach(function (valuePair) {
        var value = valuePair.y;

        if (axis == 3) {
          minValue3 = Math.min(value, minValue3);
          maxValue3 = Math.max(value, maxValue3);
        }
        else if (axis == 2) {
          minValue2 = Math.min(value, minValue2);
          maxValue2 = Math.max(value, maxValue2);
        }
        else {
          minValue1 = Math.min(value, minValue1);
          maxValue1 = Math.max(value, maxValue1);
        }
      });
    });

    var leftFormat = d3.format(',f');
    var rightFormat = function (d) {
      return '$' + d3.format(',f')(d)
    };

    var leftMargin = 70;
    var rightMargin = 50;

    var minValue1StrLen = leftFormat(minValue1).length;
    var maxValue1StrLen = leftFormat(maxValue1).length;
    var minValue2StrLen = rightFormat(minValue2).length;
    var maxValue2StrLen = rightFormat(maxValue2).length;
    var minValue3StrLen = rightFormat(minValue3).length;
    var maxValue3StrLen = rightFormat(maxValue3).length;

    // The "* 8" approximates the text width of the string
    leftMargin = Math.max(70, minValue1StrLen * 8, maxValue1StrLen * 8);
    rightMargin = Math.max(70, minValue2StrLen * 8, maxValue2StrLen * 8);

    nv.addGraph(function () {
      // Use the extended chart code
      var chart = nv.models.multiLineChart()
          .margin({top: 30, right: rightMargin, bottom: 50, left: leftMargin})
          .x(function (d, i) {
            return i
          })
          .y(function (d) {
            return d.y
          })
          .color(d3.scale.category10().range());

      chart.xAxis
          .showMaxMin(false)
          .tickFormat(function (d) {
            var dx = dataList[0].values[d] && dataList[0].values[d].x || 0;
            return dx;
          });

      chart.y1Axis.tickFormat(leftFormat);
      chart.y2Axis.tickFormat(rightFormat);
      chart.y3Axis.tickFormat(rightFormat);

      delete dataList[0]['use-points'];
      delete dataList[0]['use-bars'];
      if (quantityPlotMode == "points") {
        dataList[0]['use-points'] = true;
      }
      else if (quantityPlotMode == "bars") {
        dataList[0]['use-bars'] = true;
      }

      delete dataList[1]['use-points'];
      delete dataList[1]['use-bars'];
      if (pricePlotMode == "points") {
        dataList[1]['use-points'] = true;
      }
      else if (pricePlotMode == "bars") {
        dataList[1]['use-bars'] = true;
      }

      delete dataList[2]['use-points'];
      delete dataList[2]['use-bars'];
      if (costPlotMode == "points") {
        dataList[2]['use-points'] = true;
      }
      else if (costPlotMode == "bars") {
        dataList[2]['use-bars'] = true;
      }

      if (quantityIncludeZero) {
        chart.line1.forceY([0]);
      }
      else {
        chart.line1.forceY([]);
      }

      if (priceIncludeZero) {
        chart.line2.forceY([0]);
      }
      else {
        chart.line2.forceY([]);
      }

      if (costIncludeZero) {
        chart.line3.forceY([0]);
      }
      else {
        chart.line3.forceY([]);
      }

      if (quantityHighlight) {
        dataList[0]['stroke-width'] = "8px";
      }
      else {
        delete dataList[0]['stroke-width'];
      }

      if (priceHighlight) {
        dataList[1]['stroke-width'] = "8px";
      }
      else {
        delete dataList[1]['stroke-width'];
      }

      if (costHighlight) {
        dataList[2]['stroke-width'] = "8px";
      }
      else {
        delete dataList[2]['stroke-width'];
      }

      $('#chart1 svg').empty();

      d3.select('#chart1 svg')
          .datum(dataList)
          .transition()
          .duration(500)
          .call(chart);

      nv.utils.windowResize(chart.update);

      return chart;
    });
  }
});
</script>
</body>
</html>
