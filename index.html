<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <title>D3 16</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link href="css/nv.d3.css" rel="stylesheet">

  <script type="text/javascript" src="js/jquery-1.11.0.min.js"></script>
  <script type="text/javascript" src="js/d3.js"></script>
  <script type="text/javascript" src="js/nv.d3.js"></script>
  <script type="text/javascript" src="js/nvx.d3.js"></script>
</head>
<body>

<style>
  #chart1 svg {
    height: 350px;
    width: 600px;
  }
</style>

<select id="quantityPlotMode" name="plotMode">
  <option value="smoothLine">Smooth Line</option>
  <option value="points">Points</option>
  <option value="bars">Bars</option>
</select>

<select id="pricePlotMode" name="plotMode">
  <option value="smoothLine">Smooth Line</option>
  <option value="points">Points</option>
  <option value="bars">Bars</option>
</select>

<input type="checkbox" id="quantityIncludeZero">Quantity Include Zero
<input type="checkbox" id="priceIncludeZero">Price Include Zero

<input type="checkbox" id="quantityHighlight">Quantity Highlight
<input type="checkbox" id="priceHighlight">Price Highlight

<div id="chart1">
  <svg></svg>
</div>

<script type="text/javascript">
  $(document).ready(function () {

    var quantityPlotMode = "smoothLine";
    var pricePlotMode = "smoothLine";
    var quantityIncludeZero = false;
    var priceIncludeZero = false;
    var quantityHighlight = false;
    var priceHighlight = false;
    var dataList = [];

    $("#pricePlotMode").on("change", function (e) {
      pricePlotMode = $('#pricePlotMode').val();

      if (dataList.length > 0) {
        redraw();
      }
    });

    $("#quantityPlotMode").on("change", function (e) {
      quantityPlotMode = $('#quantityPlotMode').val();

      if (dataList.length > 0) {
        redraw();
      }
    });

    $("#quantityIncludeZero").on("change", function (e) {
      quantityIncludeZero = $('#quantityIncludeZero').is(':checked');

      if (dataList.length > 0) {
        redraw();
      }
    });

    $("#priceIncludeZero").on("change", function (e) {
      priceIncludeZero = $('#priceIncludeZero').is(':checked');

      if (dataList.length > 0) {
        redraw();
      }
    });

    $("#quantityHighlight").on("change", function (e) {
      quantityHighlight = $('#quantityHighlight').is(':checked');

      if (dataList.length > 0) {
        redraw();
      }
    });

    $("#priceHighlight").on("change", function (e) {
      priceHighlight = $('#priceHighlight').is(':checked');

      if (dataList.length > 0) {
        redraw();
      }
    });

    d3.json("data.json", function (error, data) {
      dataList = data;
      redraw();
    });

    function redraw() {
      var minValue1 = Number.MAX_VALUE;
      var maxValue1 = Number.MIN_VALUE;
      var minValue2 = Number.MAX_VALUE;
      var maxValue2 = Number.MIN_VALUE;

      dataList.forEach(function (data) {
        var axis = data.axis;
        data.values.forEach(function (valuePair) {
          var value = valuePair[1];

          if (axis == 1) {
            minValue1 = Math.min(value, minValue1);
            maxValue1 = Math.max(value, maxValue1);
          }
          else {
            minValue2 = Math.min(value, minValue2);
            maxValue2 = Math.max(value, maxValue2);
          }
        });
      });

      var leftFormat = d3.format(',f');
      var rightFormat = function (d) {
        return '$' + d3.format(',f')(d)
      };

      var leftMargin = 70;
      var rightMargin = 50;

      var minValue1StrLen = leftFormat(minValue1).length;
      var maxValue1StrLen = leftFormat(maxValue1).length;
      var minValue2StrLen = rightFormat(minValue2).length;
      var maxValue2StrLen = rightFormat(maxValue2).length;

      // The "* 8" approximates the text width of the string
      leftMargin = Math.max(70, minValue1StrLen * 8, maxValue1StrLen * 8);
      rightMargin = Math.max(70, minValue2StrLen * 8, maxValue2StrLen * 8);

      nv.addGraph(function () {
        // Use the extended chart code
        var chart = nv.models.multiLineChart()
            .margin({top: 30, right: rightMargin, bottom: 50, left: leftMargin})
            .x(function (d, i) {
              return i
            })
            .y(function (d) {
              return d[1]
            })
            .color(d3.scale.category10().range());

        chart.xAxis
            .showMaxMin(false)
            .tickFormat(function (d) {
              var dx = dataList[0].values[d] && dataList[0].values[d][0] || 0;
              return d3.time.format('%x')(new Date(dx))
            });

        chart.y1Axis.tickFormat(leftFormat);
        chart.y2Axis.tickFormat(rightFormat);

        if (quantityPlotMode == "points") {
          dataList[0]['use-points'] = true;
        }
        else {
          delete dataList[0]['use-points'];
        }

        if (pricePlotMode == "points") {
          dataList[1]['use-points'] = true;
        }
        else {
          delete dataList[1]['use-points'];
        }

        if (quantityIncludeZero) {
          chart.line1.forceY([0]);
        }
        else {
          chart.line1.forceY([]);
        }

        if (priceIncludeZero) {
          chart.line2.forceY([0]);
        }
        else {
          chart.line2.forceY([]);
        }

        if (quantityHighlight) {
          dataList[0]['stroke-width'] = "8px";
        }
        else {
          delete dataList[0]['stroke-width'];
        }
        if (priceHighlight) {
          dataList[1]['stroke-width'] = "8px";
        }
        else {
          delete dataList[1]['stroke-width'];
        }

        $('#chart1 svg').empty();

        d3.select('#chart1 svg')
            .datum(dataList)
            .transition()
            .duration(500)
            .call(chart);

        nv.utils.windowResize(chart.update);

        return chart;
      });
    }
  });
</script>
</body>
</html>
